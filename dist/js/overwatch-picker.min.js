'use strict';

angular.module('overwatch-hero-picker', ['ngDialog']).run(function (ngDialog, LocalStorageKeys) {

    if (!localStorage.getItem(LocalStorageKeys.helpBoxRememberClose)) {
        ngDialog.open({
            template: 'how-to-use.html'
        });
    }
});
'use strict';

angular.module('overwatch-hero-picker').config(function ($httpProvider, ngDialogProvider) {
    $httpProvider.defaults.cache = true;

    ngDialogProvider.setDefaults({
        className: 'ngdialog-theme-default',
        width: '50%',
        closeByDocument: true,
        closeByEscape: true
    });
});
'use strict';

angular.module('overwatch-hero-picker').constant('LocalStorageKeys', {
    heroesRatings: 'ow-player-hero-rating',
    helpBoxRememberClose: 'help-box-remember-close'
});
'use strict';

angular.module('overwatch-hero-picker').constant('MapModes', {
    O: "Offense",
    D: "Defense",
    KOTH: "King of the Hill"
});
'use strict';

angular.module('overwatch-hero-picker').component('owHelpBoxRemember', {
    template:'<label for=remember-help-close><input type=checkbox ng-checked=$ctrl.isKeepShowingChecked id=remember-help-close checked ng-click=$ctrl.rememberHelpClose($event)> Keep showing this box upon my next visit.<br>(You can view this box again using the button at the top right of the page)</label>',
    controller: function controller(LocalStorageKeys) {

        this.isKeepShowingChecked = !localStorage.getItem(LocalStorageKeys.helpBoxRememberClose);

        this.rememberHelpClose = function ($event) {
            if ($event.target.checked) {
                localStorage.removeItem(LocalStorageKeys.helpBoxRememberClose);
            } else {
                localStorage.setItem(LocalStorageKeys.helpBoxRememberClose, 'true');
            }
        };
    }
});
'use strict';

angular.module('overwatch-hero-picker').component('owHeroList', {
    bindings: {
        selectedHeroes: '='
    },
    template:'<ul class=list><li ng-repeat="hero in $ctrl.heroes | orderBy: \'name\'" ng-class="{ \'selected\': $ctrl.selectedHeroes[hero.id], \'disabled\' : !$ctrl.selectedHeroes[hero.id] && $ctrl.maxReached }"><button ng-click=$ctrl.selectHero(hero) href=javascript:void()><img ng-src={{hero.avatar}}><div class=detail-wrapper><span class=name>{{hero.name}}</span></div></button></li></ul>',

    controller: function controller(HeroesService, $scope) {
        var _this = this;

        //   this.selectedHeroes = this.selectedHeroes || [];

        var checkMaxReached = function checkMaxReached() {
            _this.maxReached = Object.keys(_this.selectedHeroes).length === 6;
        };

        this.selectHero = function (hero) {
            if (angular.isDefined(_this.selectedHeroes[hero.id])) {
                delete _this.selectedHeroes[hero.id];
            } else if (!_this.maxReached) {
                _this.selectedHeroes[hero.id] = hero;
            }

            checkMaxReached();
        };

        HeroesService.getHeroes().then(function (heroes) {
            _this.heroes = heroes;
        });

        checkMaxReached();
    }
});
'use strict';

angular.module('overwatch-hero-picker').component('owHeroPickerScore', {
    bindings: {
        map: '<',
        counter: '<',
        final: '<'
    },
    controller: function controller() {
        this.abs = Math.abs;
    },
    template:'<div class=score ng-class="{\'negative\' : $ctrl.final < 0}">{{$ctrl.final | number:1 }} <small>(C)&nbsp;{{ $ctrl.counter| number: 1 }}</small> <small>(M)&nbsp;{{ $ctrl.map| number: 1 }}</small></div>'
});
'use strict';

angular.module('overwatch-hero-picker').component('owHeroPicker', {
    template:'<header><div class=logo><img src=/dist/media/overwatch_03_flat.svg> <small>Overwatch<sup>TM</sup> is a registered trademark of Blizzard Entertainment</small></div><div class="header-title picker">Pick hero(es) to counter</div><div class="header-title map">Chose a map <span class=mode0>Offense</span>, <span class=modeD>Defense</span> or <span class=modeKOTH>Assault</span></div><div class="header-title recommended">You should pick (from <span class=modeD>best</span> to <span class=modeO>worst</span>)</div><div class=right-tools><button ng-dialog=how-to-use.html ng-dialog-class=ngdialog-theme-default>Help</button> <button class=hamburger ng-click="navOpened = !navOpened">Player settings</button></div><nav class=nav ng-class="{open : navOpened}"><ow-reset-player-hero-rating heroes-rating=$ctrl.heroesRating></ow-reset-player-hero-rating><ow-player-hero-rating heroes-rating=$ctrl.heroesRating></ow-player-hero-rating></nav></header><main class=content><ow-hero-list class=opponents selected-heroes=$ctrl.selectedHeroes></ow-hero-list><ow-map-list selected-map=$ctrl.selectedMap></ow-map-list><div class=recommendation ng-show=$ctrl.heroesList.length><ul class="recommended clearfix"><li ng-repeat="hero in $ctrl.heroesList | filter: $ctrl.recommendedFilter | limitTo: $ctrl.heroesLimit"><img ng-src="{{ hero.avatar }}"><ow-hero-picker-score final=$ctrl.heroFinalScore[hero.id] counter=$ctrl.heroCounterScore[hero.id] map=$ctrl.heroMapScore[hero.id]></ow-hero-picker-score></li></ul><input type=checkbox id=hero-limit ng-click=$ctrl.toggleHeoresLimit($event)><label for=hero-limit>Show all ratings</label></div></main>',
    controller: function controller($q, $scope, HeroesService, HeroPickerService, LocalStorageKeys) {
        var _this = this;

        var minHeroShown = 12;

        this.heroesLimit = minHeroShown;
        this.selectedHeroes = {};
        this.heroesList = [];
        this.heroesRating = angular.fromJson(localStorage.getItem(LocalStorageKeys.heroesRatings)) || {};
        this.selectedMap = null;

        $scope.$watch('$ctrl.selectedMap', function (value) {
            if (angular.isDefined(value)) {
                _this.getRecommendedHero();
            }
        });

        $scope.$watch('$ctrl.selectedHeroes', function (value) {
            if (value) {
                _this.getRecommendedHero();
            }
        }, true);

        $scope.$watch('$ctrl.heroesRating', function (value) {
            if (value) {
                _this.getRecommendedHero();
                localStorage.setItem(LocalStorageKeys.heroesRatings, angular.toJson(_this.heroesRating));
            }
        }, true);

        this.getRecommendedHero = function () {
            return $q.all({
                ratings: HeroPickerService.getRecommendedHero(_this.selectedHeroes, _this.selectedMap, _this.heroesRating),
                heroesList: HeroesService.getHeroes()
            }).then(function (r) {
                _this.heroLimit = minHeroShown;
                _this.heroFinalScore = r.ratings.finalRating;
                _this.heroCounterScore = r.ratings.heroCounterRating;
                _this.heroMapScore = r.ratings.heroMapRating;

                _this.heroesList = r.heroesList.sort(function (heroA, heroB) {
                    if (r.ratings.finalRating[heroB.id] === r.ratings.finalRating[heroA.id]) {
                        if (heroA.name > heroB.name) {
                            return 1;
                        }
                        if (heroA.name < heroB.name) {
                            return -1;
                        }
                        return 0;
                    }
                    return r.ratings.finalRating[heroB.id] - r.ratings.finalRating[heroA.id];
                });
            });
        };

        this.toggleHeoresLimit = function ($event) {
            if ($event.target.checked) {
                _this.heroesLimit = null;
            } else {
                _this.heroesLimit = minHeroShown;
            }
        };

        this.recommendedFilter = function (hero) {
            return _this.heroesLimit != minHeroShown || _this.heroFinalScore[hero.id] >= 0;
        };
        this.avoidFilter = function (hero) {
            return _this.heroFinalScore[hero.id] > 0;
        };
    }
});
'use strict';

angular.module('overwatch-hero-picker').component('owMapList', {
    bindings: {
        selectedMap: '='
    },
    template:'<ul class=list><li ng-repeat="map in $ctrl.maps" class="{{\'mode\' + map.mode}}" ng-class="{ \'selected\': $ctrl.selectedMap === map, \'disabled\' : $ctrl.selectedMap !== null && map !== $ctrl.selectedMap }"><button ng-click=$ctrl.selectMap(map)><img ng-src={{map.image}}><div class=detail-wrapper><span class=name>{{map.name}}</span></div></button></li></ul>',
    controller: function controller(MapsService, MapModes) {
        var _this = this;

        this.selectedMap = null;
        this.mapModes = MapModes;
        MapsService.getMaps().then(function (maps) {
            _this.maps = maps.sort(function (a, b) {
                if (a.mode === 'KOTH' && b.mode !== 'KOTH') {
                    return 1;
                }
                if (b.mode === 'KOTH' && a.mode !== 'KOTH') {
                    return -1;
                }
                if (a.id > b.id) {
                    return 1;
                }
                if (a.id < b.id) {
                    return -1;
                }
                //
                // if (a.mode === 'O' && b.mode === 'D'){
                //     return 1;
                // }
                // if (b.mode === 'D' && a.mode === 'O'){
                //     return -1
                // }

                return 0;
            });
        });

        this.selectMap = function (map) {
            if (map === _this.selectedMap) {
                _this.selectedMap = null;
            } else {
                _this.selectedMap = map;
            }
        };
    }
});
'use strict';

angular.module('overwatch-hero-picker').component('owPlayerHeroRating', {
    bindings: {
        heroesRating: '='
    },
    template:'<ul class=list><li ng-repeat="hero in $ctrl.heroes | orderBy: \'name\'"><img ng-src={{hero.avatar}}><div class=detail-wrapper><span class=name>{{hero.name}} <span class=pull-right>(<span ng-show="$ctrl.heroesRating[hero.id] > 0">+</span>{{$ctrl.heroesRating[hero.id]}})</span></span> <input type=range min=-5 max=5 ng-model=$ctrl.heroesRating[hero.id]></div></li></ul>',
    controller: function controller(HeroesService) {
        var _this = this;

        HeroesService.getHeroes().then(function (heroes) {
            _this.heroes = heroes;

            angular.forEach(heroes, function (hero) {
                _this.heroesRating[hero.id] = _this.heroesRating[hero.id] || 0;
            });
        });
    }
});
'use strict';

angular.module('overwatch-hero-picker').component('owResetPlayerHeroRating', {
    template: '<button ng-click="$ctrl.resetRatings()">Reset ratings</button>',
    bindings: {
        heroesRating: '='
    },
    controller: function controller(LocalStorageKeys) {
        var _this = this;

        this.resetRatings = function () {
            localStorage.removeItem(LocalStorageKeys.heroesRatings);
            // debugger;
            for (var i in _this.heroesRating) {
                if (_this.heroesRating.hasOwnProperty(i)) {
                    _this.heroesRating[i] = 0;
                }
            }
        };
    }
});
'use strict';

angular.module('overwatch-hero-picker').service('HeroesService', function ($http) {
    this.getHeroes = function () {
        return $http.get('data/heroes.json').then(function (response) {
            return response.data;
        });
    };
    this.getMatching = function () {
        return $http.get('data/matching.json').then(function (response) {
            return response.data;
        });
    };
});
'use strict';

angular.module('overwatch-hero-picker').service('HeroPickerService', function ($q, HeroesService) {

    this.getRecommendedHero = function (opposingHeroes, map, heroesRating) {
        return $q.all({
            heroes: HeroesService.getHeroes(),
            matching: HeroesService.getMatching()
        }).then(function (result) {
            var recommendedCounterByHero = {};
            var recommendedByMap = {};
            var finalRating = {};
            var nbOpponent = Object.keys(opposingHeroes).length || 6;

            //(Hero1+Hero2+Hero3+Hero4+Hero5+Hero6+(MapRating x opposingHeroesCount *.4)) x PlayerRating
            for (var pickHeroId in result.matching) {
                if (result.matching.hasOwnProperty(pickHeroId)) {
                    recommendedCounterByHero[pickHeroId] = 0;

                    for (var opposingHeroId in opposingHeroes) {
                        if (opposingHeroes.hasOwnProperty(opposingHeroId)) {
                            recommendedCounterByHero[pickHeroId] += result.matching[pickHeroId].heroes[opposingHeroId] || 0;
                        }
                    }

                    if (map) {
                        recommendedByMap[pickHeroId] = result.matching[pickHeroId].maps[map.id] || 0;
                    } else {
                        recommendedByMap[pickHeroId] = 0;
                    }
                    finalRating[pickHeroId] = recommendedCounterByHero[pickHeroId] * -1 + recommendedByMap[pickHeroId] * nbOpponent * 0.4 + heroesRating[pickHeroId] * nbOpponent * 0.6;
                }
            }

            return {
                heroCounterRating: recommendedCounterByHero,
                heroMapRating: recommendedByMap,
                finalRating: finalRating
            };
        });
    };
});
'use strict';

angular.module('overwatch-hero-picker').service('MapsService', function ($http) {
    this.getMaps = function () {
        return $http.get('data/maps.json').then(function (response) {
            return response.data;
        });
    };
});